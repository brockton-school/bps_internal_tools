{% extends "base.html" %}
{% block title %}Admin Settings Â· Internal Tools{% endblock %}
{% block content %}
<div class="card">
  <h2 style="margin-top:0">Roles</h2>
  <form method="post" action="{{ url_for('admin.create_role') }}" style="margin-bottom:16px;">
    <label>Role name</label>
    <input class="input" name="role" required placeholder="e.g. admin">

    <label>Tools (comma-separated or * for all)</label>
    <input class="input" name="tools" placeholder="e.g. toc_attendance,tool_b or *">

    <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
      <input type="checkbox" name="active" checked> Active
    </label>

    <button class="btn" type="submit">Create Role</button>
  </form>

  <div class="grid">
    {% for r in roles %}
    <div class="tile" style="flex-direction:column; align-items:stretch;">
      <form method="post" action="{{ url_for('admin.update_role_route', role=r.role) }}">
        <div><strong>{{ r.role }}</strong> {% if not r.active %}<span style="color:#ffa6a6;">(inactive)</span>{% endif %}</div>
        <label style="margin-top:8px;">Tools (comma-separated or *)</label>
        <input class="input" name="tools" value="{{ '*' if r.tools == ['*'] else (r.tools|join(',')) }}">
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
          <input type="checkbox" name="active" {% if r.active %}checked{% endif %}> Active
        </label>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn" type="submit" style="width:auto;">Save</button>
          <form method="post" action="{{ url_for('admin.delete_role_route', role=r.role) }}" onsubmit="return confirm('Delete role {{r.role}}?')">
            <button class="btn danger" type="submit" style="width:auto;">Delete</button>
          </form>
        </div>
      </form>
    </div>
    {% endfor %}
  </div>
</div>

<div class="card" style="margin-top:16px;">
  <h2 style="margin-top:0">Users</h2>
  <form method="post" action="{{ url_for('admin.create_user_route') }}" style="margin-bottom:16px;">
    <label>Username</label>
    <input class="input" name="username" required>
    <label>Display Name</label>
    <input class="input" name="display_name">
    <label>Role</label>
    <select class="input" name="role" required>
      {% for r in roles if r.active %}
      <option value="{{ r.role }}">{{ r.role }}</option>
      {% endfor %}
    </select>
    <label>Password</label>
    <input class="input" type="password" name="password" required>
    <button class="btn" type="submit">Create User</button>
  </form>

  <div class="grid">
    {% for u in users %}
    <div class="tile" style="flex-direction:column; align-items:stretch;">
      <form method="post" action="{{ url_for('admin.update_user_route', username=u.username) }}">
        <div><strong>{{ u.username }}</strong> {% if not u.active %}<span style="color:#ffa6a6;">(inactive)</span>{% endif %}</div>
        <label style="margin-top:8px;">Display Name</label>
        <input class="input" name="display_name" value="{{ u.display_name }}">
        <label>Role</label>
        <select class="input" name="role">
          {% for r in roles if r.active %}
          <option value="{{ r.role }}" {% if r.role == u.role %}selected{% endif %}>{{ r.role }}</option>
          {% endfor %}
        </select>
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
          <input type="checkbox" name="active" {% if u.active %}checked{% endif %}> Active
        </label>
        <label>New Password (optional)</label>
        <input class="input" type="password" name="new_password" placeholder="Leave blank to keep existing">
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn" type="submit" style="width:auto;">Save</button>
          <form method="post" action="{{ url_for('admin.delete_user_route', username=u.username) }}" onsubmit="return confirm('Delete user {{u.username}}?')">
            <button class="btn danger" type="submit" style="width:auto;">Delete</button>
          </form>
        </div>
      </form>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
