{% extends "base.html" %}
{% block title %}Admin · Roles{% endblock %}
{% block content %}
<div class="card">
  <h2 style="margin-top:0">Create Role</h2>
  <form method="post" action="{{ url_for('admin.create_role') }}" style="margin-bottom:16px;">
    <label>Role name</label>
    <input class="input" name="role" required placeholder="e.g. admin">

    <label>Tools this role can access</label>
    <div class="grid">
      {% for t in tools %}
        <label class="tile">
          <input type="checkbox" name="tools[]" value="{{ t.slug }}">
          <span>{{ t.name }} <span style="color:var(--muted);">({{ t.slug }})</span></span>
        </label>
      {% endfor %}
      <!-- Optional “All tools” checkbox -->
      <label class="tile">
        <input type="checkbox" name="tools[]" value="*">
        <span>All Tools <span style="color:var(--muted);">(admin)</span></span>
      </label>
    </div>

    <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
      <input type="checkbox" name="active" checked> Active
    </label>

    <button class="btn" type="submit">Create Role</button>
  </form>
</div>

<div class="card" style="margin-top:16px;">
  <h2 style="margin-top:0">Existing Roles</h2>

  {% for r in roles %}
    <form id="form-{{ r.role }}" method="post" action="{{ url_for('admin.update_role_route', role=r.role) }}"></form>
    <form id="delete-{{ r.role }}" method="post" action="{{ url_for('admin.delete_role_route', role=r.role) }}"></form>
  {% endfor %}

  <table class="table">
    <thead>
      <tr>
        <th>Tool / Feature</th>
        {% for r in roles %}
          <th>
            <div class="col" style="gap:8px;">
              <div>
                <strong>{{ r.role }}</strong>
                {% if not r.active %}<span style="color:#ffa6a6;">(inactive)</span>{% endif %}
              </div>
              <div class="row">
                <button class="btn" type="submit" form="form-{{ r.role }}">Save</button>
                <button
                  class="btn danger outline confirm-delete"
                  type="submit"
                  form="delete-{{ r.role }}"
                  formnovalidate
                  aria-label="Delete role {{ r.role }}"
                >Delete</button>
              </div>
            </div>
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for t in tools %}
        <tr>
          <td>{{ t.name }} <span style="color:var(--muted);">({{ t.slug }})</span></td>
          {% for r in roles %}
            {% set allowed = r.tools %}
            <td style="text-align:center;">
              <input type="checkbox" name="tools[]" value="{{ t.slug }}"
                     {% if '*' in allowed or t.slug in allowed %}checked{% endif %}
                     form="form-{{ r.role }}">
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
      <tr>
        <td>All Tools</td>
        {% for r in roles %}
          <td style="text-align:center;">
            <input type="checkbox" name="tools[]" value="*"
                   {% if r.tools == ['*'] %}checked{% endif %}
                   form="form-{{ r.role }}">
          </td>
        {% endfor %}
      </tr>
      <tr>
        <td>Active</td>
        {% for r in roles %}
          <td style="text-align:center;">
            <input type="checkbox" name="active" {% if r.active %}checked{% endif %} form="form-{{ r.role }}">
          </td>
        {% endfor %}
      </tr>
    </tbody>
  </table>
</div>
{% endblock %}
